# DDLDoor
ICカードで施錠および解錠を行うデバイスと連携する入退室および勤怠管理社内システムです。
<br>基本的には、端末に関する事項は由水へ、Webアプリに関する事項は新井へご連絡ください。

<br>

# 仕様 (Webアプリ)
## 互換性
Chrome, Edge, Android Chrome, iOS Safari, iOS Chromeに対応し、PWA対応ブラウザではPWA(主にアプリをインストール)が使えます。
スマホ版は情報量が制限され、必要最低限の機能になります。


## 認証
管理者アカウントがメールアドレスを元に一般または管理者アカウントを払い出すことができます。初回ログイン後は生成されたパスワードを変更してください。<br>
PCならサイドバーの下部、スマホならツールバーの右部にあるトグルボタンを押すとパスワード変更およびログアウト、メンバーリンクができます。<br>
Webアプリ上のアカウントと、後述するメンバーの間に直接的な関係がないので、メンバーリンクからアカウントに対して、各自のメンバーを紐づけることを推奨しています。メンバーリンクにおけるアカウントとメンバーはシステム通して一対一対応します。<br>セキュリティ上の理由から初期パスワードを利用し続けることはできません。


## メニュー
- ダッシュボード<br>
初期画面です。このページはリアルタイムで更新されます。スマホ版はアンチパスバックのみ対応しています。<br> 上部に管理者からのメッセージが表示され、クリックまたは右端のxボタンで既読として非表示になります。管理者は後述の「メンテナンス」においてメッセージを作成できます。


- メンバー<br>
二つのタブに分かれます。
  - 一覧タブ<br>
  メンバーの一覧です。各メンバーに対して右端のトグルから初期化、編集、削除、手動打刻の機能が用意されています。メンバーの削除はそれに紐づく全てのカードIDmも同時に削除されます。<br>**アンチパスバックエラーになった場合、対応するメンバーの状況コラムに!のアイコンが出現しますので、それを押して解除してください。**<br>メンバーリンク済みのメンバーは手動打刻が利用できます。手動打刻とは、Webアプリ上でデバイスを選択して、疑似タッチができるもので、出張や在宅時の利用を想定しています。アクションコラムの団子アイコンを押すとそのダイアログが表示されます。<br>メンバーリンクされているメンバーは当該ユーザー以外、アクション操作ができません。メンバーに対する予期しない削除等の操作から保護するための機能です。

  - 状況タブ<br>
  メンバーの在外状況等が簡易的に表示されます。

- ログ<br>
カードタッチや一時解錠等のイベント情報を出力します。期間指定でフィルターができ、CSV出力ができます。<br>全体を通して、ログデータのロード方式は無限スクロール仕様になっています。フィルター機能の期間指定の内容は連続して変更でき、フィルターオフの際だけ更新ロゴを押してください。

- カードID<br>
Felicaカードの登録、編集、削除ができます。同様にボタンからダイアログが表示されます。登録ダイアログでは、外付けカードリーダー(PaSoRi)からカード情報を取得し、アプリ内に反映させることができますが、何らかの方法で取得したIDmを直打ちしても同様に登録が可能です。無許可デバイスIDでは、カードに対して、解錠を許可しないデバイスを設定することができます。<br>
すべてのカードはあるメンバーに紐づけられている必要があります。

- デバイス<br>
実際の運用における端末の設定情報を管理できます。現在、DDLには社員用出入口、来客用出入口が存在します。一般アカウントでは一部制限はありますが、登録および編集ができます。管理者アカウントでは削除などの運用に影響を及ぼす機能も利用できます。<br>
出口の役割を持つデバイスのみ一時解錠機能が利用できます。また、最大解錠時間が設定でき、編集機能からその値を変更できます。<br>パートナーコラムを追加しました。これは本来関係のない二つのデバイスによって「ドア」を構成するための機能です。<br>デバイスの設定項目に、手動打刻機能において仮想デバイスとして運用される「バーチャル」があります。既に実運用に応じた設定が済んでいます。

- 勤務時間<br>
二つのタブに分かれます。
  - 一覧<br>
  すべてのメンバーの任意月における勤務時間に関する情報が表示されます。原則、前日までの打刻データが計算対象になります。ここにおける打刻データは30分の丸め処理がされ、原則実務時間は休憩時間として1時間分が引かれます。<br>「*」が付く時刻は手動打刻によるものを表します。休日の勤務時間は全て残業として計上されます。
  - 出力<br>
  すべてのメンバーの生の打刻データを細かいフィルター機能をもって、表示およびCSV出力ができます。

- メンテナンス(管理者アカウントのみ)<br>
  - アカウント<br>
  管理者かどうかを選択してメールアドレスを元にアカウントを発行および削除ができます。
  - 休日設定<br>
  勤務時間の一覧に表示される休日を設定できます。
  - メッセージ<br>
  ダッシュボードに表示されるメッセージを作成できます。
  - Danger Zone<br>
  状態管理をしないモードへの変更、期間を指定したログの一括削除ができます。

<br>

# 仕様 (端末)

## 通常打刻
Webアプリに登録されているカードをタッチすることでドアが解錠され、サーバに打刻が残ります。登録されていない、または登録されていても有効化されていないカードはNGとなります。<br>

## 一時解錠
出口端末 (事務所の内側にある端末) の右ボタンを押すと「Touch to Open (Temp)」と表示され、
このとき有効なカードをタッチすると「Temporary Open OK」の表示とともに**一時解錠状態**になります。タッチせずに右ボタンを再度押す、または一定時間が経過するとキャンセルされます。<br>
**一時解錠状態**ではドアを閉じても施錠されず、警報(後述)も鳴りません。荷物の搬入・搬出など、ドアを長時間開放し続ける必要がある場合にご利用ください。一時解錠中であっても通常の打刻は可能です。<br>
一時解錠状態で左右どちらかのボタンを押すと「Push Center to Close」と表示され、このとき中央のボタンを押すと「Close Request OK」の表示とともに一時解錠状態を終了します。また、Webアプリで設定可能な最大解錠時間が経過することでも終了します。<br>
Webアプリのデバイスメニューから一時解錠/施錠を行うことも可能です。

## 来客タッチ
出口端末 (事務所の内側にある端末) の左ボタンを押すと「Touch to Open (Guest)」と表示され、
このとき有効なカードをタッチすると「Guest Touch OK」の表示とともに**アンチパスバックの在室/外室を切り替えずに**ドアが解錠されます。タッチせずに左ボタンを押す、または一定時間が経過するとキャンセルされます。<br>
来客の際など、「外出したいわけではないがドアを開けたい」という場合にご利用ください。

## 警報機能
- サムターン錠等端末へのカードタッチ以外でドアが解錠された場合
- 解錠後、一定時間施錠がされない場合
- 一時解錠終了時にドアが開放されており、その後一定時間施錠がされない場合

以上の場合に警報が鳴り続けます。警報が鳴っていても端末の操作は可能です。

- ドアが施錠された場合
- 一時解錠状態になった場合

以上の場合に警報が解除されます。

## 強制開錠 (緊急用)
「電源を入れ、タイムタッチの画面が表示される前に電源を切る」を4回以上繰り返すと、次回起動時に強制的にドアが解錠されます。緊急時にのみご利用ください。画面が表示されると回数はリセットされます。<br>
(電源のオンオフが早すぎると回数がカウントされない場合があります。電源を入れて1~2秒程度、音声再生モジュール初期化時のノイズを目印にすると確実です)


<br>

# 開発向け
- フロントエンド<br>
  Angular (v13), Angular Material. 言語はTypescript, HTML/SCSS<br>
  PWAに対応し、主にキャッシュによる高速化とバージョン制御の機能を実装

- バックエンド<br>
  Amazon Linux 2上でNode.js (Express)アプリをpm2でデーモン化し、言語はJavascript<br>
  ビルド済みクライアントアプリを静的ファイルとしてホスト

- DB<br>
  MongoDB

- Webサーバー<br>
  Apacheをリバースプロキシにて利用<br>
  Let's EncryptでSSL化し、証明書は自動更新<br>

- バックアップ戦略<br>
  サーバーにおけるAMIそのものを毎週日曜の深夜にAWS上に保存ないしは更新します。加えて、二時間に一回、DBの全データをAWSのS3上に保存します。DBの全データの有効期限は2日です。AWSの認証情報は環境ファイルに格納しています。

- 端末設定<br>
  SDカード内の設定ファイル init.conf から端末起動時に以下の設定が読み込まれます。
  - 端末MACアドレス
  - 端末ID
  - 端末IPアドレス
  - DNSサーバIPアドレス
  - ネットマスク
  - ゲートウェイIPアドレス
  - 通常タッチ音量
  - 警報音量
  - 通常解錠時の警報鳴動開始猶予 (秒)
  - NTP通信間隔 (秒)
  - RTCのFCR Integer部初期値
